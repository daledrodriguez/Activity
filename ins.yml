- name: Search or create source IP host object
  vars:
    object_filter: "asa-{{ source_ip }}"
  block:
    - name: Search source IP host object
      checkpoint_object_facts:
        object_filter: "{{ object_filter }}"
        object_type: host
      register: source_object

    - name: Create source IP host object if not exists
      checkpoint_host:
        name: "{{ object_filter }}"
        ip_address: "{{ source_ip }}"
      when: not source_object['ansible_facts']['checkpoint_objects']
  when: source_ip is defined

- name: Search or create destination IP host object
  vars:
    object_filter: "asa-{{ destination_ip }}"
  block:
    - name: Search destination IP host object
      checkpoint_object_facts:
        object_filter: "{{ object_filter }}"
        object_type: host
      register: dest_object

    - name: Create destination IP host object if not exists
      checkpoint_host:
        name: "{{ object_filter }}"
        ip_address: "{{ destination_ip }}"
      when: not dest_object['ansible_facts']['checkpoint_objects']
  when: destination_ip is defined

- name: Create access rule to deny access from source to destination
  checkpoint_access_rule:
    layer: Network
    position: top
    name: "asa-drop-{{ source_ip }}-to-{{ destination_ip }}"
    source: "asa-{{ source_ip }}"
    destination: "asa-{{ destination_ip }}"
    action: drop
  when: source_ip is defined and destination_ip is defined
